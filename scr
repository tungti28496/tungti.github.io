html = `<h3 style="margin: 20px 0; color: #28a745; font-size: 1.3em;">âœ… TÃ¬m tháº¥y ${results.length} vÄƒn báº£n cÃ³ chá»©a "${query}"</h3>`;
        
        results.forEach(result => {
            const doc = result.document;
            const matches = result.matches;
            
            html += `
                <div class="result-item">
                    <div class="result-header">
                        <h3>${doc.title}</h3>
                        ${doc.source === 'file' ? '<span class="badge">ğŸ“„ File Word</span>' : ''}
                    </div>
                    <div class="document-meta">
                        <span>ğŸ“„ ${typeNames[doc.type]}</span>
                        <span>ğŸ“… NÄƒm ${doc.year}</span>
                        <span>ğŸ¯ ${matches.length} káº¿t quáº£</span>
                        ${doc.fileName ? `<span>ğŸ“ ${doc.fileName}</span>` : ''}
                    </div>
                    <div style="margin-top: 15px;">
            `;

            matches.slice(0, 5).forEach(match => {
                html += `
                    <div class="match-item">
                        <div class="match-header">
                            <strong>
                                ${match.type === 'title' ? 'ğŸ“‹ TiÃªu Ä‘á»' : ''}
                                ${match.type === 'description' ? 'ğŸ“ MÃ´ táº£' : ''}
                                ${match.type === 'content' ? 'ğŸ“„ Ná»™i dung' : ''}
                                ${match.label ? `ğŸ“ ${match.label} ${match.number}` : ''}
                            </strong>
                            ${match.label ? `<a href="#" onclick="viewDocument(${doc.id}); return false;">ğŸ‘ï¸ Xem vÄƒn báº£n</a>` : ''}
                        </div>
                        ${match.title ? `<p style="font-weight: 600; margin-bottom: 8px;">${match.title}</p>` : ''}
                        <div class="match-content">
                            ${highlightText(match.text.substring(0, 400), query)}
                            ${match.text.length > 400 ? '...' : ''}
                        </div>
                    </div>
                `;
            });

            if (matches.length > 5) {
                html += `<p style="color: #666; font-style: italic; margin-top: 10px;">... vÃ  ${matches.length - 5} káº¿t quáº£ khÃ¡c</p>`;
            }

            html += `
                    </div>
                    <button class="btn-small btn-view" style="margin-top: 15px;" onclick="viewDocument(${doc.id})">
                        ğŸ‘ï¸ Xem vÄƒn báº£n Ä‘áº§y Ä‘á»§
                    </button>
                </div>
            `;
        });

        resultsDiv.innerHTML = html;
    }

    // Highlight text
    function highlightText(text, query) {
        if (!query || !text) return text;
        const regex = new RegExp(`(${query})`, 'gi');
        return text.replace(regex, '<mark>$1</mark>');
    }

    // View document
    function viewDocument(id) {
        const doc = documents.find(d => d.id === id);
        if (!doc) return;

        if (doc.source === 'file' && doc.content) {
            const newWindow = window.open('', '_blank');
            newWindow.document.write(`
                <html>
                    <head>
                        <title>${doc.title}</title>
                        <meta charset="UTF-8">
                        <style>
                            body { 
                                font-family: Arial, sans-serif; 
                                padding: 40px; 
                                line-height: 1.8; 
                                max-width: 900px; 
                                margin: 0 auto;
                                background: #f5f5f5;
                            }
                            .container {
                                background: white;
                                padding: 40px;
                                border-radius: 10px;
                                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                            }
                            h1 { 
                                color: #1e3c72; 
                                border-bottom: 3px solid #1e3c72; 
                                padding-bottom: 15px;
                                margin-bottom: 20px;
                            }
                            .meta { 
                                color: #666; 
                                margin-bottom: 30px;
                                padding: 15px;
                                background: #f8f9fa;
                                border-radius: 5px;
                            }
                            .content { 
                                white-space: pre-wrap;
                                font-size: 1.05em;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="container">
                            <h1>${doc.title}</h1>
                            <div class="meta">
                                <strong>Loáº¡i:</strong> ${typeNames[doc.type]} | 
                                <strong>NÄƒm:</strong> ${doc.year} | 
                                <strong>File:</strong> ${doc.fileName}<br>
                                ${doc.description ? `<strong>MÃ´ táº£:</strong> ${doc.description}<br>` : ''}
                                <strong>Sá»‘ Ä‘iá»u khoáº£n:</strong> ${doc.articles.length}
                            </div>
                            <div class="content">${doc.content}</div>
                        </div>
                    </body>
                </html>
            `);
        } else if (doc.source === 'url' && doc.url) {
            window.open(doc.url, '_blank');
        }
    }

    // Filter documents
    function filterDocuments() {
        updateDocumentLists();
    }

    // Update document lists
    function updateDocumentLists() {
        const typeFilter = document.getElementById('filterType').value;
        const yearFilter = document.getElementById('filterYear').value;

        const filtered = documents.filter(doc => {
            const matchType = typeFilter === 'all' || doc.type === typeFilter;
            const matchYear = yearFilter === 'all' || doc.year.toString() === yearFilter;
            return matchType && matchYear;
        });

        updateDocumentList('documentListSearch', filtered.length > 0 ? filtered : documents);
        updateDocumentList('documentListManage', documents);
    }

    // Update document list
    function updateDocumentList(elementId, docs) {
        const listDiv = document.getElementById(elementId);
        
        if (docs.length === 0) {
            listDiv.innerHTML = `
                <div class="empty-state">
                    <h3>ğŸ“­ ChÆ°a cÃ³ vÄƒn báº£n</h3>
                    <p>ThÃªm vÄƒn báº£n trong tab "Cáº­p nháº­t vÄƒn báº£n"!</p>
                </div>
            `;
            return;
        }

        let html = '';
        docs.forEach(doc => {
            html += `
                <div class="document-item">
                    <div class="document-header">
                        <div class="document-title" style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <h3>${doc.title}</h3>
                                ${doc.source === 'file' ? '<span class="badge">ğŸ“„ Word</span>' : ''}
                            </div>
                            ${doc.description ? `<p style="color: #666; margin-bottom: 8px;">${doc.description}</p>` : ''}
                            <div class="document-meta">
                                <span>ğŸ“„ ${typeNames[doc.type]}</span>
                                <span>ğŸ“… ${doc.year}</span>
                                <span>â• ${doc.addedDate}</span>
                                ${doc.fileName ? `<span>ğŸ“ ${doc.fileName}</span>` : ''}
                                ${doc.articles && doc.articles.length > 0 ? `<span>ğŸ“ ${doc.articles.length} Ä‘iá»u khoáº£n</span>` : ''}
                            </div>
                        </div>
                        <div class="document-actions">
                            <button class="btn-small btn-view" onclick="viewDocument(${doc.id})">
                                ğŸ‘ï¸ Xem
                            </button>
                            <button class="btn-small btn-delete" onclick="deleteDocument(${doc.id})">
                                ğŸ—‘ï¸ XÃ³a
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });

        listDiv.innerHTML = html;
    }

    // Update year filter
    function updateYearFilter() {
        const yearFilter = document.getElementById('filterYear');
        const years = [...new Set(documents.map(doc => doc.year))].sort((a, b) => b - a);
        
        let options = '<option value="all">Táº¥t cáº£ nÄƒm</option>';
        years.forEach(year => {
            options += `<option value="${year}">${year}</option>`;
        });
        
        yearFilter.innerHTML = options;
    }

    // Update stats
    function updateStats() {
        document.getElementById('totalDocs').textContent = documents.length;
        document.getElementById('totalSearches').textContent = searchCounter;
        document.getElementById('nghiDinhCount').textContent = 
            documents.filter(d => d.type === 'nghi-dinh').length;
        document.getElementById('thongTuCount').textContent = 
            documents.filter(d => d.type === 'thong-tu').length;
        document.getElementById('fileCount').textContent = 
            documents.filter(d => d.source === 'file').length;
    }

    // Update UI
    function updateUI() {
        updateDocumentLists();
        updateStats();
    }

    // Enter key support
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('searchQuery').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') searchDocuments();
        });

        document.getElementById('docUrl').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addDocument();
        });

        loadData();
    });
</script>
