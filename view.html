<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xem chi ti·∫øt vƒÉn b·∫£n</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px 40px;
        }

        header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .back-button {
            display: inline-block;
            margin-bottom: 15px;
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: background 0.2s;
        }

        .back-button:hover {
            background: rgba(255,255,255,0.3);
        }

        .content {
            padding: 40px;
        }

        .document-meta {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 5px solid #1e3c72;
        }

        .document-meta h3 {
            color: #1e3c72;
            margin-bottom: 15px;
        }

        .meta-item {
            margin-bottom: 10px;
            color: #666;
        }

        .meta-item strong {
            color: #333;
        }

        .search-info {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            color: #856404;
        }

        .search-info strong {
            color: #1e3c72;
        }

        .document-content {
            line-height: 1.9;
            font-size: 1.05em;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #333;
        }

        .document-content .highlight {
            background: #ffeb3b;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            border: 2px solid #fdd835;
            box-shadow: 0 2px 5px rgba(253, 216, 53, 0.3);
        }

        .document-content .target-position {
            background: #ff9800;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 700;
            border: 3px solid #f57c00;
            box-shadow: 0 3px 15px rgba(255, 152, 0, 0.5);
            animation: pulse 2s infinite;
            display: inline-block;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 3px 15px rgba(255, 152, 0, 0.5);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 5px 25px rgba(255, 152, 0, 0.8);
                transform: scale(1.02);
            }
        }

        .scroll-indicator {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #1e3c72;
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            font-weight: 600;
            animation: bounce 2s infinite;
            z-index: 1000;
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        .scroll-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            transition: all 0.3s;
            z-index: 999;
            display: none;
        }

        .scroll-to-top:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }

        .scroll-to-top.show {
            display: block;
        }

        .article-link {
            background: #e3f2fd;
            border: 2px solid #1e3c72;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
            margin: 4px;
            text-decoration: none;
            color: #1e3c72;
            font-weight: 600;
        }

        .article-link:hover {
            background: #1e3c72;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(30, 60, 114, 0.3);
        }

        .article-navigation {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 5px solid #28a745;
            max-height: 400px;
            overflow-y: auto;
        }

        .article-navigation h4 {
            color: #28a745;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .article-navigation::-webkit-scrollbar {
            width: 8px;
        }

        .article-navigation::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .article-navigation::-webkit-scrollbar-thumb {
            background: #28a745;
            border-radius: 10px;
        }

        .article-navigation::-webkit-scrollbar-thumb:hover {
            background: #218838;
        }

        footer {
            background: #f8f9fa;
            padding: 20px;
            text-align: center;
            color: #666;
            border-top: 1px solid #dee2e6;
        }

        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }

            header h1 {
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <a href="index.html" class="back-button">‚Üê Quay l·∫°i t√¨m ki·∫øm</a>
            <h1 id="docTitle">ƒêang t·∫£i vƒÉn b·∫£n...</h1>
        </header>

        <div class="content">
            <div class="document-meta" id="docMeta"></div>
            <div class="search-info" id="searchInfo"></div>
            <div class="document-content" id="docContent"></div>
        </div>

        <footer>
            <p>H·ªá th·ªëng tra c·ª©u vƒÉn b·∫£n ph√°p lu·∫≠t ¬© 2024</p>
        </footer>
    </div>

    <div class="scroll-indicator" id="scrollIndicator" style="display: none;">
        ‚Üì V·ªã tr√≠ t·ª´ kh√≥a b√™n d∆∞·ªõi
    </div>

    <button class="scroll-to-top" id="scrollToTop" onclick="scrollToTopFunc()" title="L√™n ƒë·∫ßu trang">
        ‚Üë
    </button>

    <script>
        window.addEventListener('load', function() {
            loadDocument();
        });

        function loadDocument() {
            const data = sessionStorage.getItem('currentDocument');
            
            if (!data) {
                document.getElementById('docTitle').textContent = 'Kh√¥ng t√¨m th·∫•y vƒÉn b·∫£n';
                document.getElementById('docContent').innerHTML = 
                    '<div style="text-align: center; padding: 60px; color: #999;">' +
                    '<h3>‚ùå L·ªói</h3>' +
                    '<p>Kh√¥ng t√¨m th·∫•y th√¥ng tin vƒÉn b·∫£n. Vui l√≤ng quay l·∫°i trang t√¨m ki·∫øm.</p>' +
                    '<a href="index.html" style="display: inline-block; margin-top: 20px; padding: 10px 25px; background: #1e3c72; color: white; text-decoration: none; border-radius: 8px;">‚Üê Quay l·∫°i</a>' +
                    '</div>';
                return;
            }

            const params = JSON.parse(data);
            const doc = params.doc;
            const mode = params.mode || 'search';

            // Update title
            document.getElementById('docTitle').textContent = doc.name;

            // Update metadata
            let metaHTML = '<h3>üìã Th√¥ng tin vƒÉn b·∫£n</h3>';
            metaHTML += '<div class="meta-item"><strong>T√™n file:</strong> ' + doc.fileName + '</div>';
            metaHTML += '<div class="meta-item"><strong>S·ªë ƒëi·ªÅu kho·∫£n:</strong> ' + doc.articles.length + '</div>';
            metaHTML += '<div class="meta-item"><strong>GitHub:</strong> <a href="' + doc.url + '" target="_blank" style="color: #1e3c72;">Xem tr√™n GitHub</a></div>';
            document.getElementById('docMeta').innerHTML = metaHTML;

            // Create article navigation
            if (doc.articles && doc.articles.length > 0) {
                let navHTML = '<div class="article-navigation">';
                navHTML += '<h4>üìë Danh m·ª•c ƒëi·ªÅu kho·∫£n - Click ƒë·ªÉ di chuy·ªÉn (T·ªïng: ' + doc.articles.length + ')</h4>';
                
                const uniqueArticles = [];
                doc.articles.forEach(function(article) {
                    const key = article.label + '-' + article.number;
                    const exists = uniqueArticles.find(function(a) {
                        return (a.label + '-' + a.number) === key;
                    });
                    if (!exists) {
                        uniqueArticles.push(article);
                    }
                });

                uniqueArticles.forEach(function(article) {
                    navHTML += '<a href="#article-' + article.position + '" class="article-link" onclick="scrollToArticle(' + article.position + '); return false;">';
                    navHTML += article.label + ' ' + article.number;
                    navHTML += '</a>';
                });

                navHTML += '</div>';
                document.getElementById('docMeta').insertAdjacentHTML('afterend', navHTML);
            }

            // Update search info based on mode
            let infoHTML = '';
            if (mode === 'article') {
                infoHTML = 'üìç <strong>ƒêang xem tr·ª±c ti·∫øp:</strong> ' + params.articleLabel + ' ' + params.articleNumber + ' | ';
                infoHTML += 'üéØ <strong>V·ªã tr√≠ ƒë∆∞·ª£c ƒë√°nh d·∫•u m√†u cam v√† t·ª± ƒë·ªông scroll</strong>';
                document.getElementById('searchInfo').innerHTML = infoHTML;
                
                const highlightedContent = highlightArticle(doc.content, params.position, doc.articles);
                document.getElementById('docContent').innerHTML = highlightedContent;
            } else {
                infoHTML = 'üîç <strong>T·ª´ kh√≥a t√¨m ki·∫øm:</strong> "' + params.query + '" | ';
                infoHTML += 'üìç <strong>V·ªã tr√≠ kh·ªõp ƒë∆∞·ª£c ƒë√°nh d·∫•u m√†u cam v√† t·ª± ƒë·ªông scroll</strong>';
                document.getElementById('searchInfo').innerHTML = infoHTML;
                
                const highlightedContent = highlightContent(doc.content, params.query, params.position, doc.articles);
                document.getElementById('docContent').innerHTML = highlightedContent;
            }

            setTimeout(function() {
                scrollToTarget();
            }, 800);
        }

        function highlightArticle(content, targetPosition, articles) {
            let result = content;
            
            const sortedArticles = articles.slice().sort(function(a, b) {
                return b.position - a.position;
            });

            sortedArticles.forEach(function(article) {
                const isTarget = Math.abs(article.position - targetPosition) < 20;
                const before = result.substring(0, article.position);
                const articleText = article.fullMatch;
                const after = result.substring(article.position + articleText.length);
                
                let wrapped = '';
                if (isTarget) {
                    wrapped = '<span id="article-' + article.position + '" class="highlight target-position" data-target="true">' + articleText + '</span>';
                } else {
                    wrapped = '<span id="article-' + article.position + '" class="highlight">' + articleText + '</span>';
                }
                
                result = before + wrapped + after;
            });

            return result;
        }

        function highlightContent(content, query, targetPosition, articles) {
            let result = highlightArticle(content, targetPosition, articles);

            const regex = new RegExp('(' + escapeRegex(query) + ')', 'gi');
            const matches = [];
            let match;
            
            const tempRegex = new RegExp(regex);
            const plainContent = content;
            
            while ((match = tempRegex.exec(plainContent)) !== null) {
                matches.push({
                    start: match.index,
                    end: match.index + match[0].length,
                    text: match[0],
                    isTarget: Math.abs(match.index - targetPosition) < 50
                });
            }

            matches.forEach(function(m) {
                if (m.isTarget) {
                    const searchRegex = new RegExp('(<span[^>]*>)?' + escapeRegex(m.text) + '(</span>)?', 'gi');
                    result = result.replace(searchRegex, function(matched) {
                        if (matched.includes('<span')) return matched;
                        return '<span class="highlight target-position" data-target="true">' + m.text + '</span>';
                    });
                }
            });

            return result;
        }

        function scrollToTarget() {
            let target = document.querySelector('[data-target="true"]');
            
            if (target) {
                const indicator = document.getElementById('scrollIndicator');
                indicator.style.display = 'block';

                setTimeout(function() {
                    const elementPosition = target.getBoundingClientRect().top;
                    const offsetPosition = elementPosition + window.pageYOffset - 150;

                    window.scrollTo({
                        top: offsetPosition,
                        behavior: 'smooth'
                    });
                    
                    setTimeout(function() {
                        indicator.style.display = 'none';
                    }, 3000);
                }, 200);
            } else {
                console.log('Target element not found for scrolling');
            }
        }

        function scrollToArticle(position) {
            const element = document.getElementById('article-' + position);
            if (element) {
                const elementPosition = element.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - 150;

                window.scrollTo({
                    top: offsetPosition,
                    behavior: 'smooth'
                });
                
                element.style.transition = 'all 0.5s';
                element.style.transform = 'scale(1.05)';
                element.style.boxShadow = '0 5px 20px rgba(255, 152, 0, 0.6)';
                
                setTimeout(function() {
                    element.style.transform = 'scale(1)';
                    element.style.boxShadow = '';
                }, 1000);
            } else {
                console.log('Article element not found:', position);
            }
        }

        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function scrollToTopFunc() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        window.addEventListener('scroll', function() {
            const scrollToTopBtn = document.getElementById('scrollToTop');
            const scrollIndicator = document.getElementById('scrollIndicator');
            
            if (window.pageYOffset > 300) {
                scrollToTopBtn.classList.add('show');
            } else {
                scrollToTopBtn.classList.remove('show');
            }

            if (scrollIndicator.style.display === 'block' && window.pageYOffset > 0) {
                setTimeout(function() {
                    scrollIndicator.style.display = 'none';
                }, 1000);
            }
        });
    </script>
</body>
</html>
